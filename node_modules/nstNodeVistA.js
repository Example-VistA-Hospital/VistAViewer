/*
	VistA Utilities
	Author: Nikolay Topalov

	Copyright 2014 Nikolay Topalov

	Licensed under the Apache License, Version 2.0 (the "License");
	you may not use this file except in compliance with the License.
	You may obtain a copy of the License at
	
	http://www.apache.org/licenses/LICENSE-2.0
	
	Unless required by applicable law or agreed to in writing, software
	distributed under the License is distributed on an "AS IS" BASIS,
	WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
	See the License for the specific language governing permissions and
	limitations under the License.
*/

	// simple $piece implementation
var piece = function(str,delimiter,position) {
		
		if (str === undefined) return "";
		
		var buf = str.split(delimiter);
		
		return (buf[position-1] === undefined) ? "" : buf[position-1]; 
		
	};

// return a global node as a string 	
var getNA = function(pGlobalNode) {  //,'^' + ewd.temp._globalName + '("' + ewd.temp._subscripts.join('","') + '","RPC")'; 
    var globalName = "^" + pGlobalNode.global + "("; 
	
	if (pGlobalNode.subscripts.length > 0) {
		globalName +=  '"' + pGlobalNode.subscripts.join('","') + '"';
	}
	
	if (arguments.length > 1) {
		var args = [];
		for (var i = 1; i < arguments.length; i += 1) {
			args.push(arguments[i]);
		}
		if (pGlobalNode.subscripts.length > 0) {
			globalName += ',';
		}
		globalName += '"' + args.join('","') + '"';
	};
	
	globalName += ')';
	
	return globalName;   
};

module.exports = {
	rpc: { 
		'new': function(pRPCName) {
			var result = {"name" : pRPCName, "input": []};
			return result;
		},

		execute: function(pRPC, ewd) {
			var ewdtemp = new ewd.mumps.GlobalNode('TMP',['ewd',process.pid]); 
			ewdtemp.$('RPC')._delete();	
			ewdtemp.$('RPC')._setDocument(pRPC);
			var temp = getNA(ewdtemp._node,"RPC");  // e.g., ^TMP("ewd","3740","RPC")
			
			var str = ewd.mumps.function("rpcExecute^nstRPCWrapper", temp);
			var result = JSON.parse(str);

			if (result.success) {
				result.result = ewdtemp.$('RPC').$('result')._getDocument();
				result.callback = pRPC.callback;
			};

			ewdtemp.$('RPC')._delete();
			
			return result;	
		}
	},
	di : {
		/* 
		 * $$EXTERNAL^DILFD(FILE,FIELD,FLAGS,INTERNAL,MSG_ROOT)
		 */
		FieldExternalValue : function(pFile, pField, pFlags, pIntValue, ewd) {
			var res = ewd.mumps.function("EXTERNAL^DILFD",pFile,pField,pFlags,pIntValue);
			return res; 		
		},

		/*
		 *	returns FileMan file name by file number
		 *  $$GET1^DID(FILE,"","","NAME")
		 */
		fileName: function(pFile, ewd) {
				var res = ewd.mumps.function("GET1^DID",pFile,"","","NAME");
				return res; 		
		},

		/* 
		 *  returns FileMan file record name (field .01)
		 *  $$GET1^DIQ(pFile,pIEN,.01)
		 */
		 recordName: function(pFile, pIEN, ewd) {
				var res = ewd.mumps.function("GET1^DIQ",pFile,pIEN,".01");
				return res; 		
		},

		/*	
		 *	find a record in a FileMan file - returns IEN, ignores errors
		 *	$$FIND1^DIC(FILE,IENS,FLAGS,[.]VALUE,[.]INDEXES,[.]SCREEN,MSG_ROOT)
		 */
		findExactMatchByName: function(pFile, pValue, ewd) {
				var res = ewd.mumps.function("FIND1^DIC",pFile,"","QX",pValue);
				return res; 	
		},

		/*  returns FileMan file global root 
		 *	$$ROOT^DILFD(FILE)
		*/
		fileRoot: function(pFile, ewd) { 		
				var res = ewd.mumps.function("ROOT^DILFD",pFile);
				return res; 		
		},

		/*
		 *	GETS^DIQ(pFile,pIEN_",",pFields,pFlags,"OUT","ERR")
		 */
		recordByIEN: function(pFile, pIEN, pFields, pFlags, ewd) {
			var params = {input: {}};

			params.input.pFile = pFile;
			params.input.pIEN = pIEN;
			params.input.pFlags = pFlags;
			params.input.pFields = pFields;
			
			var ewdtemp = new ewd.mumps.GlobalNode('TMP',['ewd',process.pid]); 
			ewdtemp.$('TMP')._delete();
			ewdtemp.$('TMP')._setDocument(params);
			var temp = getNA(ewdtemp._node,"TMP");  // e.g., ^TMP("ewd","3740","TMP")
			
			var str = ewd.mumps.function("getFileRecordByIEN^nstNodeUtils", temp);
			var result = JSON.parse(str);

			if (result.success) {
				result.result = ewdtemp.$('TMP').$('result')._getDocument();
			} else {
				result.error = ewdtemp.$('TMP').$('error')._getDocument();
			}

			ewdtemp.$('TMP')._delete();		
			return result;
		},

		/*
		 *	returns a list with all fields in a file
		 *	$$GET1^DID(pFile,fldId,"","SPECIFIER")
		 */
		fileFields: function(pFile, ewd) {
			var params = {input: {}};

			params.input.pFile = pFile;
			
			var ewdtemp = new ewd.mumps.GlobalNode('TMP',['ewd',process.pid]); 
			ewdtemp.$('TMP')._delete();
			ewdtemp.$('TMP')._setDocument(params);
			var temp = getNA(ewdtemp._node,"TMP");  // e.g., ^TMP("ewd","3740","TMP")
			
			var str = ewd.mumps.function("getFileFields^nstNodeUtils", temp);
			var result = JSON.parse(str);
			
			if (result.success) {
				result.result = ewdtemp.$('TMP').$('result')._getDocument();
			} else {
				result.error = ewdtemp.$('TMP').$('error')._getDocument();
			}
			
			ewdtemp.$('TMP')._delete();		
			return result;
		},

		// return number of records in a node
		getRecordsCounter: function(node) {
			var tmp = node.$(0)._value;
			var counter = piece(tmp,'^',4);		// number of records
			return counter;	
		},
		
		/*
		 * return FileMan field attributes
		 * D FIELD^DID(pFilepField,pFlags,pAttributes,"OUT","ERR")
		 */
		fieldRetriever: function(pFile, pField, pFlags, pAttributes, ewd) {
			var params = {input: {}};

			params.input.pFile = pFile;
			params.input.pField = pField;
			params.input.pFlags = pFlags;
			params.input.pAttributes = pAttributes;

			
			var ewdtemp = new ewd.mumps.GlobalNode('TMP',['ewd',process.pid]); 
			ewdtemp.$('TMP')._delete();
			ewdtemp.$('TMP')._setDocument(params);
			var temp = getNA(ewdtemp._node,"TMP");  // e.g., ^TMP("ewd","3740","TMP")
			
			var str = ewd.mumps.function("getFieldAttributes^nstNodeUtils", temp);
			var result = JSON.parse(str);

			if (result.success) {
				result.result = ewdtemp.$('TMP').$('result')._getDocument();
			} else {
				result.error = ewdtemp.$('TMP').$('error')._getDocument();
			}

			ewdtemp.$('TMP')._delete();		
			return result;
		}
	},

	getNA: getNA,
	
	// returns M routine code
	getRoutineCode: function(pRoutineName, ewd) {
		// Cache stores routines in ^ROUTINE
		//var root = new ewd.mumps.GlobalNode('ROUTINE', [params.routineName]);		
		//var routine = root._getDocument();
		
		// use function to get the routine code
		var param = {"input": [ {"value" : pRoutineName} ]};
		var tempGlobal = new ewd.mumps.GlobalNode('TMP',['ewd',process.pid,'RPC']);
		tempGlobal._delete();
		tempGlobal._setDocument(param);
		var result = [];
		
		var tmp = getNA(tempGlobal._node);  // e.g., ^TMP("ewd","3740","RPC")
		var res = ewd.mumps.function("getRoutine^nstNodeUtils",tmp);
		
		var routineCode = tempGlobal.$('result')._getDocument(1);
		for (var i = 0; i < routineCode.length; i += 1) {
			result.push(routineCode[i][0]);			
		};
		//for (var i in routineCode) { result.push(routineCode[i][0]); };
		
		tempGlobal._delete();
		
		return result;
	}
};