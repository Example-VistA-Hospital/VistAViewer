/*
	VistA Viewer
	Author: Nikolay Topalov

	Copyright 2014 Nikolay Topalov

	Licensed under the Apache License, Version 2.0 (the "License");
	you may not use this file except in compliance with the License.
	You may obtain a copy of the License at
	
	http://www.apache.org/licenses/LICENSE-2.0
	
	Unless required by applicable law or agreed to in writing, software
	distributed under the License is distributed on an "AS IS" BASIS,
	WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
	See the License for the specific language governing permissions and
	limitations under the License.
*/
var vista = require('nstNodeVistA');

// returns M routine code
var getPatchRoutineList = function(pPatchIEN, ewd) {
		
		// use M function to get the routine list
		var param = {"input": {"patchIEN" : pPatchIEN}};
		var tempGlobal = new ewd.mumps.GlobalNode('TMP',['ewd',process.pid,'RPC']);
		tempGlobal._delete();
		tempGlobal._setDocument(param);
	
		var tmp = getNA(tempGlobal._node);  // e.g., ^TMP("ewd","3740","RPC")
		var res = ewd.mumps.function("getPatchRoutineList^nstNodeUtils",tmp);
		var result = tempGlobal.$('result')._getDocument();
		tempGlobal._delete();	
		return result;
	};
	
// returns a global node as a string 	
var getNA = function(globalNode) {  //,'^' + ewd.temp._globalName + '("' + ewd.temp._subscripts.join('","') + '","RPC")'; 
    var globalName = "^" + globalNode.global + "("; 
	
	if (globalNode.subscripts.length > 0) {
		globalName +=  '"' + globalNode.subscripts.join('","') + '"';
	}
	
	if (arguments.length > 1) {
		var args = [];
		for (var i = 1; i < arguments.length; i++) {
			args.push(arguments[i]);
		}
		if (globalNode.subscripts.length > 0) {
			globalName += ',';
		}
		globalName += '"' + args.join('","') + '"';
	};
	
	globalName += ')';
	
	return globalName;  
};	
	// simple $piece 
var piece = function(str,delimiter,position) {
		
		if (str === undefined) return "";
		
		var buf = str.split(delimiter);
		
		return (buf[position-1] === undefined) ? "" : buf[position-1]; 
		
	};

 	// returns word-processing field value
	// root is the global node of the field e.g., ^XWB(8994,D0,1)
var wordProcessingGlobal = function(root) {

		var result = "";
		var line;
		var x = root._getDocument();
		for (line in x) {
			if (line > 0) result += x[line] + '\n';
		}
				
		return result;	
	}; 
	
	// returns word-processing field value
	// root is the array with the WP field value
var wordProcessingArray = function(root) {

		var result = "";
		var line;
		for (line in root) {
			if (line > 0) result += root[line] + '\n';
		}
				
		return result;	
	};

	// returns a list by patch IEN (pPatchIEN) and Kernel component (pFile)
var getKernelList = function(pPatchIEN, pFile, ewd) { 

	var result = [];
	var root = new ewd.mumps.GlobalNode('XPD', [9.6, pPatchIEN,"KRN",pFile,"NM","B"]);
	
	var rootComponentGlobal = vista.di.fileRoot(pFile, ewd);
	rootComponentGlobal = piece(rootComponentGlobal,'(',1)
	rootComponentGlobal.substring(2,rootComponentGlobal.length-1);
	
	var indices =  (pFile === '.4' || pFile === '.401' || pFile === '.402') ? ["B"] : [pFile,"B"];
	var rootComponent = new ewd.mumps.GlobalNode(rootComponentGlobal, indices);
	
	root._forEach(function(name,node) { 
				
		if (pFile === '.4' || pFile === '.401' || pFile === '.402') {
				name = piece(name,'    FILE #',1);
		};

		for (var ien=0; ; ) {
			ien = rootComponent.$(name)._next(ien);
			if (ien === "") break;
			result.push( {'ien': ien, 'name': name});							
		} 
	});
	
	return result;
};

	// returns VistA RPC definition
var getRPCDetails = function(pIEN, ewd) {

	var file = 8994;	// REMOTE PROCEDURE file (#8994)
	
	var rpcRaw = vista.di.recordByIEN(file, pIEN, "**", "ER", ewd);
	
	var iens = pIEN + ',';
	
	var attr = rpcRaw.result[file][iens];
	
	var rpc = { };
	rpc.ien = pIEN;
	rpc.name = attr['NAME']['E'];
	rpc.tag = attr['TAG']['E'];
	rpc.routine = attr['ROUTINE']['E'];
	rpc.returnValueType = attr['RETURN VALUE TYPE']['E'];
	rpc.availability = attr['AVAILABILITY']['E'];
	rpc.inactive = attr['INACTIVE']['E'];
	rpc.clientManager = attr['CLIENT MANAGER']['E'];
	rpc.wordWrapOn = attr['WORD WRAP ON']['E'];
	rpc.version = attr['VERSION']['E'];

	rpc.description = wordProcessingArray(attr['DESCRIPTION']);
	rpc.returnValueDescription = wordProcessingArray(attr['RETURN PARAMETER DESCRIPTION']);
	
	rpc.inputParameters = [];
	
	var inputParameters = rpcRaw.result['8994.02'];
	var inputParameter;
	for (var i in inputParameters) {
		inputParameter = {};
		inputParameter.name = inputParameters[i]['INPUT PARAMETER']['E'];		
		inputParameter.type = inputParameters[i]['PARAMETER TYPE']['E'];	
		inputParameter.maximumLength = inputParameters[i]['MAXIMUM DATA LENGTH']['E'];
		inputParameter.required = inputParameters[i]['REQUIRED']['E'];
		inputParameter.sequence = inputParameters[i]['SEQUENCE NUMBER']['E'];
		inputParameter.description = wordProcessingArray(inputParameters[i]['DESCRIPTION']);
		rpc.inputParameters.push(inputParameter);
	};

	return rpc;
};
		
	
module.exports = {
	
	onMessage: {
	
		'processSelection' : function(params, ewd) {
			var pNameStart = params.nameStart;
			var pNameContain = params.nameContain;
			var pComponent = params.component;
			
			var componentFileNumber;
			
			if (pComponent === 'securityKey' ) {
				var componentFileNumber = 19.1;
				var componentFileName = 'SECURITY KEY';
			} else if (pComponent === 'parameterDefinition') {
				var componentFileNumber = 8989.51;
				var componentFileName = 'PARAMETER DEFINITION';		
			} else if (pComponent === 'option') {
				var componentFileNumber = 19;
				var componentFileName = 'OPTION';	
			} else if (pComponent === 'routine') {
				var componentFileNumber = 9.8;
				var componentFileName = 'ROUTINE';	
			} else {
				return;
			};				
			
			var componentGlobal = vista.di.fileRoot(componentFileNumber, ewd);
			componentGlobal = piece(componentGlobal,'(',1)
			componentGlobal.substring(2,componentGlobal.length-1);
	
			var indices =  (componentFileNumber === '.4' || componentFileNumber === '.401' || componentFileNumber === '.402') ? ["B"] : [componentFileNumber,"B"];
			
			var results = [] ;
			var componentIndex = new ewd.mumps.GlobalNode(componentGlobal, indices);		
			var componentName = (pNameStart.length > 0) ? componentIndex._previous(pNameStart) : "" ; // start from 
			var itemIEN;
			
			if ( (pNameStart.length > 0) || (pNameContain.length > 0) ) { 
				do { 
					componentName = componentIndex._next(componentName);  // get next e.g., ^XPD(9.6,"B",patchName)
					
					if (componentName.length == 0 ) break;  // quit if it is empty
									
					if ((pNameStart.length > 0) && !(componentName.slice(0, pNameStart.length) === pNameStart))
					{
							continue;
					} else if ((pNameContain.length > 0) && (componentName.indexOf(pNameContain) == -1 )) {
							continue;
					};

					itemIEN = componentIndex.$(componentName)._next('');
					
					results.push( {ien: itemIEN, name: componentName});	
				} while (true);	
			};
	
			return {
					'component' : { 'file' : componentFileNumber, 'name' : componentFileName },
					'items' : results
					};
	
		},
		
		'processDDSelection': function(params, ewd) {
			// Set parameters
			var pFileFrom = Number(params.fileFrom);
			var pFileTo = Number(params.fileTo);
			var pNameStart = params.nameStart;
			var pNameContain = params.nameContain;
			var pGlobal = params.global;
			
			// Set the file input range if need it
			pFileFrom = pFileFrom === 0 ? pFileTo : pFileFrom;
			pFileTo = pFileTo === 0 ? pFileFrom : pFileTo;
							
			var results = [] ;
			var ok;      // flag for a hit
			var dic = new ewd.mumps.GlobalNode('DIC', []);			
			var fileNumber = pFileFrom === 0 ? 0 : dic._previous(pFileFrom);
			
			do {
				fileNumber = dic._next(fileNumber);  // get next node ^DIC(8994)
				
				if (isNaN(fileNumber)) break;  // quit if it is not a number
								
				var pieces = dic.$(fileNumber).$(0)._value.split('^');
				var global = dic.$(fileNumber).$(0).$('GL')._value.split('^')[1];
				global = typeof global !== "undefined" ? global : '';
				var fileName = pieces[0];
									
				ok = fileNumber >= pFileFrom && fileNumber <= pFileTo;  // file number between
		
				if (!ok) {								
					if ((pNameStart.length > 0) && (fileName.slice(0, pNameStart.length) === pNameStart))
					{
						ok = true;	
					} else if ((pNameContain.length > 0) && (fileName.indexOf(pNameContain) != -1 )) {
						ok = true;
					} else if ((pGlobal.length > 0) && (global.slice(0, pGlobal.length) === pGlobal)) {
						ok = true;	
					}
				};
					
				if (ok) results.push( {file: fileNumber, name: fileName});	
			} while (true);	
						
			return results;	
		},
		
		'processRPCSelection': function(params, ewd) {
			// Set parameters
			var pIENFrom = Number(params.ienFrom);
			var pIENTo = Number(params.ienTo);
			var pNameStart = params.nameStart;
			var pNameContain = params.nameContain;
			var pRoutine = params.routine;
			
			// Set the IEN input range if need it
			pIENFrom = pIENFrom === 0 ? pIENTo : pIENFrom;
			pIENTo = pIENTo === 0 ? pIENFrom : pIENTo;
							
			var results = [] ;
			var ok;      // flag for a hit
			var rpcs = new ewd.mumps.GlobalNode('XWB', [8994]);			
			var ien = 0;
			
			do {
				ien = rpcs._next(ien);  // get next node ^XWB(8994,ien)
				
				if (isNaN(ien)) break;  // quit if it is not a number
								
				var pieces = rpcs.$(ien).$(0)._value.split('^');
				var rpcName = pieces[0];
									
				ok = ien >= pIENFrom && ien <= pIENTo;  // IEN between
		
				if (!ok) {

					var rpcRoutine = (typeof pieces[2] === 'undefined') ? "" : pieces[2];
									
					if ((pNameStart.length > 0) && (rpcName.slice(0, pNameStart.length) === pNameStart))
					{
						ok = true;	
					} else if ((pNameContain.length > 0) && (rpcName.indexOf(pNameContain) != -1 )) {
						ok = true;
					} else if ((pRoutine.length > 0) && (rpcRoutine.slice(0, pRoutine.length) === pRoutine)) {
						ok = true;	
					}
				};
					
				if (ok) results.push( {ien: ien, name: rpcName});	
			} while (true);	
						
			return {
					'component' : { 'file' : 8994, 'name' : 'REMOTE PROCEDURE' },
					'rpcs' : results
					};	
		},
		
		'processPatchSelection': function(params, ewd) {

			// Set parameters
			var pNameStart = params.nameStart;
			var pNameContain = params.nameContain;
	
			var results = [] ;
			var buildIndex = new ewd.mumps.GlobalNode("XPD", [9.6,"B"]);	// BUILD file (#9.6)		
			var buildName = (pNameStart.length > 0) ? buildIndex._previous(pNameStart) : "" ; // start from 
			var buildIEN;
			
			if ( (pNameStart.length > 0) || (pNameContain.length > 0) ) { 
				do { 
					buildName = buildIndex._next(buildName);  // get next ^XPD(9.6,"B",patchName)
					
					if (buildName.length == 0 ) break;  // quit if it is empty
									
					if ((pNameStart.length > 0) && !(buildName.slice(0, pNameStart.length) === pNameStart))
					{
							continue;
					} else if ((pNameContain.length > 0) && (buildName.indexOf(pNameContain) == -1 )) {
							continue;
					};

					buildIEN = buildIndex.$(buildName)._next('');
					
					results.push( {ien: buildIEN, name: buildName});	
				} while (true);	
			};
	
			return results;		
		},
		
		'getPatchSummary' : function(params, ewd) {
			var pPatchName = params.patchName;
			
			var patchIEN = vista.di.findExactMatchByName(9.6, pPatchName, ewd);
			
			if (patchIEN <= 0) return; // TODO patch not found
			
			var components = [];
		
			var root = new ewd.mumps.GlobalNode('XPD', [9.6, patchIEN,"KRN"]);
			
			var counter;
			// Get counter of each Kernel component
			root._forRange("0","999999",function(componentFile,node) { 
			
				counter = vista.di.getRecordsCounter(node.$('NM'));	// number of components 
				
				components.push( {'name': vista.di.fileName(componentFile, ewd), 'counter': counter, 'file': componentFile});
			});
			
			var raw = vista.di.recordByIEN(9.6, patchIEN, "*", "ER", ewd);		
			var iens = patchIEN + ',';
			var attr = raw.result[9.6][iens];
			
			var patch = {};
			patch.ien = patchIEN;
			patch.name = attr['NAME']['E'];
			patch.dateDistributed = attr['DATE DISTRIBUTED']['E'];

			patch.preInstallRoutine = attr['PRE-INSTALL ROUTINE']['E'];
			patch.postInstallRoutine = attr['POST-INSTALL ROUTINE']['E'];
			patch.environmentCheckRoutine = attr['ENVIRONMENT CHECK ROUTINE']['E'];
			
			patch.deletePreInstallRoutine = attr['DELETE ENV ROUTINE']['E'];
			patch.deletePostInstallRoutine = attr['DELETE POST-INIT ROUTINE']['E'];
			patch.deleteEnvironmentCheckRoutine = attr['DELETE PRE-INIT ROUTINE']['E'];
			
			patch.preTransportationRoutine = attr['PRE-TRANSPORTATION ROUTINE']['E'];
			
			patch.description = wordProcessingArray(attr['DESCRIPTION OF ENHANCEMENTS']);		
			
			// Get DD counter
			root = new ewd.mumps.GlobalNode('XPD', [9.6, patchIEN,4]);	
			counter = vista.di.getRecordsCounter(root); // number of DDs 
			patch.dd = {
						'counter' : counter,
						'file' : 4,
						'name' : 'Data Dictionary'
						};
									
			// Get Required patches counter
			root = new ewd.mumps.GlobalNode('XPD', [9.6, patchIEN,"REQB"]);	
			patch.requiredCounter = vista.di.getRecordsCounter(root); // number of required patches
			
			ewd.sendWebSocketMsg({
					type: 'displayPatchSummary',
					params:	{	'components': components, 
								'patch': patch	}
				});
				
			return ;
		},
				
		'getPatchComponentList' : function(params, ewd) {
			var pComponent = params.component;				
			var pPatchIEN = params.patchIEN;
			
			result = getKernelList(pPatchIEN, pComponent.file, ewd);
		
			ewd.sendWebSocketMsg({
					type: 'displayPatchComponentList',
					params:	{	'component': pComponent,
								'list': result }
				});
				
			return ;
		},
		
		'getPatchDDList' : function(params, ewd) {
			var pPatchIEN = params.patchIEN;
				
			var result =[];
			var name;
			var fullFile;
			
			var root = new ewd.mumps.GlobalNode('XPD', [9.6, pPatchIEN,4]);
			
			for (var ien=0; ; ) {
				ien = root._next(ien);
				if (isNaN(ien)) break; 
				name = vista.di.recordName(1, ien, ewd)
				fullFile = (piece(root.$(ien).$(222)._value,'^',3) === "f");
				result.push( {'fileNumber': ien, 'fileName': name, 'fullFile' : fullFile});							
			}; 
			
			ewd.sendWebSocketMsg({
					type: 'displayPatchDDList',
					params:	{	'patchIEN' : pPatchIEN,
								'list': result }
				});
				
			return ;
		},
		
		'getPatchDDDetails' : function(params, ewd) {
			var pPatchIEN = params.patchIEN;
			var pFile = params.file;
			var fileName = vista.di.fileName(pFile, ewd);
			
			var iens = pFile + ',' + pPatchIEN + ',';
			var ddDetails = vista.di.recordByIEN(9.64, iens, "**", "R", ewd);
			ddDetails.result[9.64][iens];
			
			ewd.sendWebSocketMsg({
					type: 'displayPatchDDDetails',
					params: {	'ddDetails' : ddDetails.result,
								'file' : pFile,
								'fileName' : fileName
							}				
				});
		},
		
		'getPatchRequired' : function (params, ewd) {
			var pPatchIEN = params.patchIEN;
		
			var requiredPatches = vista.di.recordByIEN(9.6, pPatchIEN + ',', "11*", "R", ewd);
			
			requiredPatches = requiredPatches.result['9.611'];

			var list =[];
			var name,action;
			for (var i in requiredPatches) {
				name = requiredPatches[i]['REQUIRED BUILD'];
				action = requiredPatches[i]['ACTION']
				list.push( { 'name': name, 'action': action });
			};			
		
			ewd.sendWebSocketMsg({
					type: 'displayPatchRequired',
					params: list
				});
		},
		
		'getPatchComponentDetails' : function(params, ewd) {				
			var component = params.component;
			var ien = params.ien;
			var name = params.name;
			
			switch (component.file)
			{
			case 'DD':
				break;
			case '8994':	// RPC
				var rpc = getRPCDetails(ien,ewd);
				ewd.sendWebSocketMsg({
					type: 'displayRPCDetails',
					params: rpc
				});
				break;
			case '9.8':		// routine
				var routineName = name;
				var routineTag = name;
				
				var routineCode = vista.getRoutineCode(routineName, ewd);
				
				ewd.sendWebSocketMsg({
					type: 'displayRoutine',
					params: {"routineName": routineName, "routineTag": routineTag, "routine": routineCode}
				});
				
				break;
			default :
				var detail = vista.di.recordByIEN(component.file, ien, "**", "ER", ewd);	// get External values and field names
				ewd.sendWebSocketMsg({
					type: 'displayPatchComponentDetails',
					params: {'component': component, 'detail' : detail.result, 'ien' : ien, 'name' : name}
				});
				break;
			}
			
			return;	
		},
			
		'getPatchRoutineList' : function(params, ewd) {
			var pPatchIEN = params.patchIEN;
		
			var result = getPatchRoutineList(pPatchIEN, ewd); 
						
			ewd.sendWebSocketMsg({
					type: 'displayPatchRoutineList',
					params: {'patchRoutineList': result}
				});

			return;
		},
		
		'getRoutine' : function(params, ewd) {
			// Set parameters
			var result = [];
			var pRoutineName = params.routineName;
			var pRoutineTag = params.routineTag;
		
			var routineCode = vista.getRoutineCode(pRoutineName, ewd); 
			
			ewd.sendWebSocketMsg({
					type: 'displayRoutine',
					params: {"routineName": pRoutineName, "routineTag": pRoutineTag, "routine": routineCode}
				});

			return;
		},
		
		'executeRPC' : function(params, ewd) {
			var rpc = vista.rpc.new(params.name);
				rpc.input = params.input;
				rpc.duz = params.duz;
				rpc.division = params.division;
				rpc.context = params.context; 
			
			var result = vista.rpc.execute(rpc, ewd);
			
			ewd.sendWebSocketMsg({
					type: 'displayExecuteRPCResult',
					params: result
				});
				
			return ;
		},
		
		'getDDDefinition' : function(params, ewd) {
			var pFile = params.file;

			var iens = pFile + ',';
			var fileName = vista.di.fileName(pFile, ewd);
			var detail = vista.di.recordByIEN(1, iens, "*", "ER", ewd);	// get External values and field names
			
			var ewdtemp = new ewd.mumps.GlobalNode('TMP',['ewd',process.pid]); 
			ewdtemp.$('TMP')._delete();
			var temp = getNA(ewdtemp._node,"TMP");  // e.g., ^TMP("ewd","3740","TMP")
			
			var res = ewd.mumps.function("ddDefinition^nstDDUtil1",pFile,temp);
			var gl = ewdtemp.$('TMP')._getDocument();
			ewdtemp.$('TMP')._delete();
			
			ewd.sendWebSocketMsg({
					type: 'displayDDDefinition',
					params: {'detail': detail.result[1][iens], 'file' : pFile, 'fileName' : fileName, 'gl' : gl }
				});
			return;
		},
		
		'getDDFieldDefinition' : function(params, ewd) {
			var pFile = params.file;
			var pField = params.field;

			var attributes = vista.di.fieldRetriever(pFile, pField, "", "", ewd);	// get all FileMan field attributes values
				
			ewd.sendWebSocketMsg({
					type: 'displayDDField',
					params: {'attributes': attributes.result, 
							 'file' : pFile, 
							 'field' : { 'number' : pField,
										 'name' : attributes.result.LABEL}
							}
				});
			return;
		},
		
		'getDDData' : function(params, ewd) {
			var pFile = params.file;

			var fields = vista.di.fileFields(pFile, ewd);
			var fileName = vista.di.fileName(pFile, ewd);
			
			// TODO
			ewd.sendWebSocketMsg({
					type: 'displayDDData',
					params: {"fields": fields.result, 'file' : pFile, 'fileName' : fileName }
				});
			return;
		}
	}
};